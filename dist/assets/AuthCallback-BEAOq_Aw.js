import{a as n,e as i,u,r as d,j as g,P as h,g as f,f as m}from"./index-lpRWoASH.js";const b=()=>{const t=n(),[r]=i(),l=u();return d.useEffect(()=>{(async()=>{try{const s=r.get("token"),c=r.get("user");if(!s||!c){console.error("Missing token or user data"),t("/login?error=missing_data");return}const o=JSON.parse(decodeURIComponent(c));console.log("ğŸ” OAuth login successful for:",o.email),console.log("ğŸ“Š Initial user data from backend:",o),localStorage.setItem("token",s),localStorage.setItem("auth_token",s);let e=o;try{const a=await f();console.log("ğŸ” Backend /auth/me response:",a),a?.data?.data?.user?e=a.data.data.user:a?.data?.user?e=a.data.user:a?.data&&(e=a.data),console.log("âœ… Canonical user from database:",e)}catch(a){console.warn("âš ï¸ Failed to fetch canonical user via /auth/me:",a),console.log("ğŸ“‹ Using user data from OAuth callback:",o)}e.role||(console.warn("âš ï¸ User missing role field, using query data as fallback"),e={...o,...e}),console.log("ğŸ¯ Role validation for dashboard access:",{userRole:e.role,isHeadUnit:e.role==="head_unit",isDirectorate:e.role==="directorate",hasDashboardAccess:["head_unit","directorate"].includes(e.role),department:e.department,unit:e.unit}),localStorage.setItem("auth_user",JSON.stringify(e)),l(m({user:e,token:s})),console.log("ğŸ“± User state updated in Redux"),console.log("ğŸ¯ Expected dashboard access:",["head_unit","directorate"].includes(e.role)?"YES":"NO"),t("/select-role",{replace:!0})}catch(s){console.error("Auth callback error:",s),t("/login?error=callback_failed")}})()},[t,r,l]),g.jsx(h,{})};export{b as default};
