import{b as h,f as m,a as f,r as b,j as p,P as k,g as R,h as A,i as E,k as S}from"./index-BN59IPuR.js";const y=()=>{const t=h(),[r]=m(),l=f();return b.useEffect(()=>{(async()=>{try{const s=r.get("token"),n=r.get("user");if(!s||!n){console.error("Missing token or user data"),t("/login?error=missing_data");return}const o=JSON.parse(decodeURIComponent(n));console.log("ğŸ” OAuth login successful for:",o.email),console.log("ğŸ“Š Initial user data from backend:",o),localStorage.setItem("token",s),localStorage.setItem("auth_token",s);let a=o;try{const e=await R();console.log("ğŸ” Backend /auth/me response:",e),e?.data?.data?.user?a=e.data.data.user:e?.data?.user?a=e.data.user:e?.data&&(a=e.data),console.log("âœ… Canonical user from database:",a)}catch(e){console.warn("âš ï¸ Failed to fetch canonical user via /auth/me:",e),console.log("ğŸ“‹ Using user data from OAuth callback:",o)}a.role||(console.warn("âš ï¸ User missing role field, using query data as fallback"),a={...o,...a});const i=A(a),d=E(a);console.log("ğŸ¯ Role validation for dashboard access:",{userRole:a.role,dashboardRole:i,delegatedFrom:a.dashboardAccess?.delegatedFromName||a.dashboardAccess?.delegatedFromEmail||null,hasDashboardAccess:d,department:a.department,unit:a.unit}),localStorage.setItem("auth_user",JSON.stringify(a)),l(S({user:a,token:s})),console.log("ğŸ“± User state updated in Redux"),console.log("ğŸ¯ Expected dashboard access:",d?"YES":"NO");const u=(a.role||"").toLowerCase(),c=r.get("redirect"),g=c&&c.startsWith("/")?c:null;t(u==="student"?"/emotional-checkin":g||"/support-hub",{replace:!0})}catch(s){console.error("Auth callback error:",s),t("/login?error=callback_failed")}})()},[t,r,l]),p.jsx(k,{})};export{y as default};
